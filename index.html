<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VYNTAR Marketplace - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center">
                    <svg class="w-8 h-8 text-gray-800 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">VYNTAR Marketplace</h1>
                        <p class="text-sm text-gray-600">Real-time lead management dashboard</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Add Lead Form -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Add Lead</h2>
                <form id="addLeadForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Buyer name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="buyerName" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Enter buyer name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Buyer email</label>
                        <input type="email" id="buyerEmail"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="buyer@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Buyer phone</label>
                        <input type="tel" id="buyerPhone"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="(555) 123-4567">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Message</label>
                        <textarea id="message" rows="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Enter lead message or inquiry"></textarea>
                    </div>
                    <button type="submit"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        Add Lead
                    </button>
                </form>
            </div>

            <!-- Leads Table -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-900">
                        Leads (<span id="leadCount">0</span>)
                    </h2>
                    <button onclick="refreshLeads()" 
                        class="flex items-center text-gray-600 hover:text-gray-900 transition-colors">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Buyer Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thread ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Message</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Leads will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
        <span id="toastMessage">Success!</span>
    </div>

    <script>
        // Initialize Supabase with correct anon key
        const supabaseUrl = 'https://hfchmjmhkiqsibxtiwsk.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhmY2htam1oa2lxc2lieHRpd3NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyOTY5NTQsImV4cCI6MjA1Mjg3Mjk1NH0.WMD4rdIiqCeNX8qYsOnelA_zog_foYo';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        // Status color mapping
        const statusColors = {
            'new': 'bg-blue-100 text-blue-800',
            'contacted': 'bg-yellow-100 text-yellow-800',
            'qualified': 'bg-green-100 text-green-800',
            'converted': 'bg-green-600 text-white',
            'lost': 'bg-red-100 text-red-800'
        };

        // Format relative time
        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return '1d ago';
            if (diffDays < 30) return `${diffDays}d ago`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)}mo ago`;
            return `${Math.floor(diffDays / 365)}y ago`;
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Render leads table
        function renderLeads(leads) {
            const tbody = document.getElementById('leadsTableBody');
            const leadCount = document.getElementById('leadCount');
            
            leadCount.textContent = leads.length;
            
            if (leads.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            No leads yet. Add your first lead above.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = leads.map(lead => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${lead.buyer_name || 'Unknown'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500 font-mono">${lead.thread_id || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <select 
                            onchange="updateLeadStatus('${lead.id}', this.value, this)"
                            class="px-3 py-1 rounded-full text-xs font-semibold ${statusColors[lead.status || 'new']} border-0 cursor-pointer transition-all duration-200">
                            <option value="new" ${lead.status === 'new' ? 'selected' : ''}>new</option>
                            <option value="contacted" ${lead.status === 'contacted' ? 'selected' : ''}>contacted</option>
                            <option value="qualified" ${lead.status === 'qualified' ? 'selected' : ''}>qualified</option>
                            <option value="converted" ${lead.status === 'converted' ? 'selected' : ''}>converted</option>
                            <option value="lost" ${lead.status === 'lost' ? 'selected' : ''}>lost</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-semibold text-gray-900">${lead.score || 0}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center text-sm text-gray-500">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            ${formatRelativeTime(lead.created_at)}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Update lead status with color change
        async function updateLeadStatus(leadId, newStatus, selectElement) {
            try {
                // Update color immediately for instant feedback
                selectElement.className = `px-3 py-1 rounded-full text-xs font-semibold ${statusColors[newStatus]} border-0 cursor-pointer transition-all duration-200`;
                
                const { error } = await supabase
                    .from('leads')
                    .update({ status: newStatus })
                    .eq('id', leadId);
                
                if (error) throw error;
                
                showToast(`Status updated to ${newStatus}`);
            } catch (error) {
                console.error('Error updating status:', error);
                showToast('Failed to update status', 'error');
                // Refresh to revert on error
                refreshLeads();
            }
        }

        // Load leads
        async function loadLeads() {
            try {
                const { data, error } = await supabase
                    .from('leads')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                renderLeads(data || []);
            } catch (error) {
                console.error('Error loading leads:', error);
                showToast('Failed to load leads', 'error');
            }
        }

        // Refresh leads
        function refreshLeads() {
            loadLeads();
            showToast('Leads refreshed');
        }

        // Add lead form submission
        document.getElementById('addLeadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const buyerName = document.getElementById('buyerName').value;
            const buyerEmail = document.getElementById('buyerEmail').value;
            const buyerPhone = document.getElementById('buyerPhone').value;
            const message = document.getElementById('message').value;
            
            try {
                const { error } = await supabase
                    .from('leads')
                    .insert([{
                        buyer_name: buyerName,
                        buyer_email: buyerEmail || null,
                        buyer_phone: buyerPhone || null,
                        message: message || null,
                        thread_id: `manual_${Date.now()}`,
                        status: 'new',
                        score: 0,
                        source: 'manual'
                    }]);
                
                if (error) throw error;
                
                showToast('Lead added successfully!');
                
                // Reset form
                e.target.reset();
                
                // Reload leads
                loadLeads();
                
            } catch (error) {
                console.error('Error adding lead:', error);
                showToast('Failed to add lead', 'error');
            }
        });

        // Set up real-time subscription
        const leadsSubscription = supabase
            .channel('leads-changes')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'leads' },
                (payload) => {
                    console.log('Real-time update:', payload);
                    loadLeads();
                }
            )
            .subscribe();

        // Initial load
        loadLeads();
    </script>
</body>
</html>
